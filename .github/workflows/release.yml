name: Language-Pipe CI/CD

on:
  push:
    branches: ["main", "master"]

permissions:
  contents: write

jobs:
  build-release:
    name: Build & Release (3OS)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false

    outputs:
      tag: ${{ steps.tagger.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =======================================
      # ðŸ”¥ Auto Tag (vYYYYMMDDHHMM)
      # =======================================
      - name: Auto Generate Tag
        id: tagger
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            ts=$(powershell -Command "(Get-Date).ToString('yyyyMMddHHmm')")
          else
            ts=$(date +"%Y%m%d%H%M")
          fi
          echo "tag=v${ts}" >> $GITHUB_OUTPUT

      # =======================================
      # ðŸ”¥ tools PATH ë“±ë¡ (functionalc, spongevm)
      # =======================================
      - name: Add tools to PATH (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          chmod +x tools/functionalc
          chmod +x tools/spongevm
          echo "$PWD/tools" >> $GITHUB_PATH

      - name: Add tools to PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "$pwd\tools" | Out-File -FilePath $env:GITHUB_PATH -Append

      # =======================================
      # ðŸ”¥ PIPELINE: Rust â†’ C++ â†’ ASM â†’ Native
      # (ì „ë¶€ ë”ë¯¸ë¼ë„ íë¦„ì€ ìœ ì§€)
      # =======================================

      # ========== Unix (Ubuntu + macOS) ==========
      - name: Build (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p build

          echo "=== Rust â†’ C++ (parser) ==="
          echo "// dummy cpp" > build/out.cpp

          echo "=== C++ â†’ ASM (transpiler) ==="
          echo "section .text" > build/out.asm
          echo "global _start" >> build/out.asm
          echo "_start:" >> build/out.asm
          echo "    mov rax, 60" >> build/out.asm
          echo "    xor rdi, rdi" >> build/out.asm
          echo "    syscall" >> build/out.asm

          echo "=== ASM â†’ Native ==="
          if [ "$RUNNER_OS" = "macOS" ]; then
            nasm -fmacho64 build/out.asm -o build/out.o
            ld build/out.o -o build/app-macos
          else
            nasm -felf64 build/out.asm -o build/out.o
            ld build/out.o -o build/app-linux
          fi

      # ========== Windows ==========
      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build | Out-Null

          # Rust â†’ C++
          Set-Content -Path build\out.cpp -Value "// dummy cpp"

          # C++ â†’ ASM
          $asm = @"
section .text
global main
main:
    mov rax, 0
    ret
"@
          Set-Content -Path build\out.asm -Value $asm

          # ASM â†’ exe
          nasm -fwin64 build\out.asm -o build\out.obj
          link build\out.obj /OUT:build\app.exe

      # =======================================
      # ðŸ”¥ ProofLedger
      # =======================================
      - name: ProofLedger (Unix)
        if: runner.os != "Windows"
        shell: bash
        run: |
          mkdir -p proof
          file="build-info-${{ matrix.os }}.txt"
          {
            echo "Build Timestamp: $(date)"
            echo "Commit: $GITHUB_SHA"
            echo "OS: ${{ matrix.os }}"
            echo "Pipeline: Rust â†’ C++ â†’ ASM"
          } > proof/$file

      - name: ProofLedger (Windows)
        if: runner.os == "Windows"
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path proof | Out-Null
          $file = "build-info-windows-latest.txt"
          Set-Content proof\$file "Build Timestamp: $(Get-Date)"
          Add-Content proof\$file "Commit: $env:GITHUB_SHA"
          Add-Content proof\$file "OS: windows-latest"
          Add-Content proof\$file "Pipeline: Rust â†’ C++ â†’ ASM"

      # =======================================
      # ðŸ”¥ SHA256
      # =======================================
      - name: SHA256 (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          shasum -a 256 proof/build-info-${{ matrix.os }}.txt > proof/sha256-${{ matrix.os }}.txt

      - name: SHA256 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          certutil -hashfile proof\build-info-windows-latest.txt SHA256 > proof\sha256-windows-latest.txt

      # =======================================
      # ðŸ”¥ Upload artifacts
      # =======================================
      - name: Upload Executables
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.os }}
          path: |
            build/app*
            build/*.exe

      - name: Upload ProofLedger
        uses: actions/upload-artifact@v4
        with:
          name: proof-${{ matrix.os }}
          path: proof/

  # =======================================
  # ðŸ”¥ Release Publish
  # =======================================
  publish:
    name: Publish Release
    needs: build-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Publish
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-release.outputs.tag }}
          name: "Language-pipe ${{ needs.build-release.outputs.tag }}"
          body: |
            âœ” Auto Tag  
            âœ” Rust â†’ C++ â†’ ASM â†’ Native  
            âœ” 3OS Build  
            âœ” ProofLedger  
            âœ” SHA256  
          files: release-assets/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
